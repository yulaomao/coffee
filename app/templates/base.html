<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>咖啡机管理后台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/v/bs5/dt-2.0.7/datatables.min.css" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
  <a class="navbar-brand" href="/dashboard"><i class="bi bi-cup-hot"></i> 咖啡机后台</a>
  {% if session.get('demo_mode') %}
    <span class="badge bg-warning text-dark ms-2">DEMO</span>
  {% endif %}
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/devices">设备</a></li>
        <li class="nav-item"><a class="nav-link" href="/orders">订单</a></li>
        <li class="nav-item"><a class="nav-link" href="/upgrades">升级</a></li>
        <li class="nav-item"><a class="nav-link" href="/recipes">配方</a></li>
        <li class="nav-item"><a class="nav-link" href="/faults">故障</a></li>
        <li class="nav-item"><a class="nav-link" href="/workorders">工单</a></li>
        <li class="nav-item"><a class="nav-link" href="/finance">财务</a></li>
        <li class="nav-item"><a class="nav-link" href="/logs">审计</a></li>
        <li class="nav-item"><a class="nav-link" href="/tasks">任务</a></li>
      </ul>
      <div class="me-2 form-check form-switch text-white">
        <input class="form-check-input" type="checkbox" id="toggleDark">
        <label class="form-check-label" for="toggleDark">暗色</label>
      </div>
  <button class="btn {% if session.get('demo_mode') %}btn-warning{% else %}btn-outline-warning{% endif %} me-2" id="toggleDemo" data-state="{% if session.get('demo_mode') %}on{% else %}off{% endif %}"><i class="bi bi-rocket"></i> Demo</button>
      <a class="btn btn-outline-light" href="/logout"><i class="bi bi-box-arrow-right"></i> 登出</a>
    </div>
  </div>
</nav>
<main class="container mt-4">
  {% block content %}{% endblock %}
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-2.0.7/datatables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
  // 暗色模式：持久化到 localStorage 并切换 :root.dark
  const DARK_KEY = 'theme-dark';
  const isDark = localStorage.getItem(DARK_KEY) === '1';
  if (isDark) document.documentElement.classList.add('dark');
  const toggleDark = document.getElementById('toggleDark');
  if (toggleDark) {
    toggleDark.checked = isDark;
    toggleDark.addEventListener('change', ()=>{
      const enabled = toggleDark.checked;
      document.documentElement.classList.toggle('dark', enabled);
      localStorage.setItem(DARK_KEY, enabled ? '1' : '0');
    });
  }
  // Demo 按钮：调用后端生成/清空示例数据
  const demoBtn = document.getElementById('toggleDemo');
  if (demoBtn) {
    demoBtn.addEventListener('click', async ()=>{
      try {
        const doing = demoBtn.dataset.state !== 'on';
        demoBtn.disabled = true; demoBtn.textContent = doing ? '生成中…' : '清空中…';
        const url = doing ? '/api/demo/load' : '/api/demo/clear';
        const res = await fetch(url, {method: 'POST'});
        const data = await res.json().catch(()=>({}));
        console.log(data);
        location.reload();
      } catch(e){ console.error(e); alert('操作失败'); }
      finally { demoBtn.disabled = false; }
    });
  }
</script>
</body>
</html>
