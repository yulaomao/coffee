{% extends 'base.html' %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-cloud-upload"></i> 设备料盒批量绑定</h4>
<p class="text-muted small">支持两种方式：1) 粘贴 JSON 数组；2) 上传 CSV 文件（列：device_no,bin_index,material_code,capacity,custom_label）。</p>
<div class="row g-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">方式一：JSON 粘贴</div>
      <div class="card-body">
        <textarea id="jsonInput" class="form-control" rows="12" placeholder='[
  {"device_no":"DEV-1001","bin_index":1,"material_code":"bean-A","capacity":120,"custom_label":"咖啡豆1"},
  {"device_no":"DEV-1002","bin_index":2,"material_code":"milk-A"}
]'></textarea>
        <div class="mt-2 d-flex gap-2">
          <button id="btnJsonSubmit" class="btn btn-primary">提交绑定</button>
          <button id="btnJsonExample" class="btn btn-outline-secondary btn-sm">示例</button>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">方式二：CSV 上传</div>
      <div class="card-body">
        <div class="mb-2">
          <label class="btn btn-outline-secondary mb-0">
            选择 CSV 文件 <input type="file" id="csvFile" accept=".csv" hidden>
          </label>
          <a class="btn btn-link btn-sm" href="#" id="btnTemplate">下载模板</a>
        </div>
        <div id="csvResult" class="small text-muted"></div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header">结果</div>
  <div class="card-body">
    <pre id="result" class="mb-0" style="white-space: pre-wrap"></pre>
  </div>
</div>

<script>
const qs = s=>document.querySelector(s);
qs('#btnJsonExample').onclick = ()=>{
  qs('#jsonInput').value = JSON.stringify([
    {device_no:'DEV-1001', bin_index:1, material_code:'bean-A', capacity:120, custom_label:'咖啡豆1'},
    {device_no:'DEV-1001', bin_index:2, material_code:'milk-A'},
  ], null, 2);
};
qs('#btnJsonSubmit').onclick = async ()=>{
  try{
    const arr = JSON.parse(qs('#jsonInput').value||'[]');
    const res = await fetch('/api/devices/bins/bulk_bind', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({items:arr})});
    const j = await res.json();
    qs('#result').textContent = JSON.stringify(j, null, 2);
  }catch(e){ alert('JSON 格式错误'); }
};
qs('#csvFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const fd = new FormData(); fd.append('file', f);
  const res = await fetch('/api/devices/bins/bulk_bind_csv', {method:'POST', body: fd});
  const j = await res.json();
  qs('#result').textContent = JSON.stringify(j, null, 2);
  qs('#csvResult').textContent = `OK: ${j.data?.ok||0}, FAIL: ${j.data?.fail||0}`;
});
qs('#btnTemplate').addEventListener('click', ()=>{
  const header = 'device_no,bin_index,material_code,capacity,custom_label\n';
  const blob = new Blob([header+'DEV-1001,1,bean-A,120,咖啡豆1\n'], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='device_bins_template.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});
</script>
{% endblock %}
