{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h3 class="mb-0"><i class="bi bi-hdd-network"></i> 设备列表</h3>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" id="chooseCols"><i class="bi bi-ui-checks"></i> 列</button>
    <button class="btn btn-outline-secondary" id="exportCsv"><i class="bi bi-download"></i> 导出CSV</button>
    <button class="btn btn-primary" id="batchCmd"><i class="bi bi-gear"></i> 批量远程操作</button>
  </div>
  </div>

<div class="row g-3 mb-2">
  <div class="col-md-2"><input id="qSearch" class="form-control" placeholder="编号/型号 搜索"></div>
  <div class="col-md-2">
    <select id="qStatus" class="form-select">
      <option value="">状态(全部)</option>
      <option value="online">在线</option>
      <option value="offline">离线</option>
    </select>
  </div>
  <div class="col-md-2">
    <select id="qMerchant" class="form-select">
      <option value="">商户(全部)</option>
      {% for m in merchants %}<option value="{{ m.id }}">{{ m.name }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <select id="qPageSize" class="form-select">
      <option>20</option><option>50</option><option>100</option>
    </select>
  </div>
  <div class="col-md-4">
    <div id="map" style="height:260px;border-radius:8px;overflow:hidden"></div>
  </div>
</div>

<table id="tbl" class="table table-striped table-hover" style="width:100%">
  <thead><tr>
    <th></th>
    <th>编号</th>
    <th>型号</th>
    <th>状态</th>
    <th>上次在线</th>
    <th>商户</th>
    <th class="editable" data-field="address">地址</th>
    <th class="editable" data-field="scene">场景</th>
    <th class="editable" data-field="customer_code">客户编码</th>
    <th>今日销量</th>
    <th>操作</th>
  </tr></thead>
  <tbody></tbody>
  </table>

<!-- 列选择弹窗 -->
<div class="modal" tabindex="-1" id="colModal">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">选择列</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="colContainer"></div>
    <div class="modal-footer"><button class="btn btn-primary" id="applyCols">应用</button></div>
  </div></div>
</div>

<!-- 批量命令弹窗 -->
<div class="modal" tabindex="-1" id="cmdModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">批量远程操作</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <select id="cmdType" class="form-select mb-2">
          <option value="reboot">重启</option>
          <option value="open_door">开门</option>
        </select>
        <div class="text-muted small">如需升级包/配方等参数，请在下发后进入“升级/配方”页面绑定包体。</div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" id="sendCmd">下发</button></div>
    </div>
  </div>
</div>

<!-- 单设备命令弹窗 -->
<div class="modal" tabindex="-1" id="singleCmdModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">设备命令</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2">设备编号：<code id="singleCmdDevice"></code></div>
        <label class="form-label">命令类型</label>
        <select id="singleCmdType" class="form-select">
          <option value="reboot">重启</option>
          <option value="open_door">开门</option>
        </select>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" id="sendSingleCmd">下发</button></div>
    </div>
  </div>
</div>

<script>
  let dt; let selected = new Set(); let markers = []; let leafletMap;
  const $ = (s)=>document.querySelector(s);

  function buildQuery(){
    const p = new URLSearchParams();
    if($('#qSearch').value) p.set('search',$('#qSearch').value);
    if($('#qStatus').value) p.set('status',$('#qStatus').value);
    if($('#qMerchant').value) p.set('merchant_id',$('#qMerchant').value);
    p.set('page', '1'); p.set('per_page', $('#qPageSize').value||'20');
    return p.toString();
  }

  async function loadData(){
    const res = await fetch('/api/devices?' + buildQuery());
    const data = await res.json();
    renderTable(data.items||[]);
    renderMap(data.items||[]);
  }

  function renderTable(items){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    items.forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="rowChk" value="${d.device_no}"></td>
        <td><a href="/devices/${encodeURIComponent(d.device_no)}">${d.device_no}</a></td>
        <td>${d.model||''}</td>
        <td><span class="badge ${d.status==='online'?'bg-success':'bg-secondary'}">${d.status||''}</span></td>
        <td>${d.last_seen?d.last_seen.replace('T',' ').slice(0,16):''}</td>
        <td>${d.merchant_name||''}</td>
        <td class="editable" data-field="address">${d.address||''}</td>
        <td class="editable" data-field="scene">${d.scene||''}</td>
        <td class="editable" data-field="customer_code">${d.customer_code||''}</td>
        <td>${d.today_sales||0}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary single-cmd" data-no="${d.device_no}">命令</button>
        </td>`;
      tbody.appendChild(tr);
    });
    if(dt) { dt.destroy(); }
    dt = new DataTable('#tbl', {
      pageLength: parseInt($('#qPageSize').value||'20'),
      pagingType: 'simple_numbers',
      dom: 't<"d-flex justify-content-between align-items-center mt-2"ip>',
      language: {
        paginate: { previous: '上一页', next: '下一页' },
        info: '第 _PAGE_ / 共 _PAGES_ 页（共 _TOTAL_ 条）',
        infoEmpty: '无记录',
        zeroRecords: '无匹配记录'
      }
    });
    // 选择
    document.querySelectorAll('.rowChk').forEach(chk=>{
      chk.addEventListener('change', ()=>{ if(chk.checked) selected.add(chk.value); else selected.delete(chk.value); });
    });
    // 行内编辑
    document.querySelectorAll('#tbl td.editable').forEach(td=>{
      td.addEventListener('dblclick', ()=>{
        const old = td.textContent; const field = td.dataset.field;
        const no = td.parentElement.querySelector('a').textContent;
        const inp = document.createElement('input'); inp.className='form-control form-control-sm'; inp.value=old; td.innerHTML=''; td.appendChild(inp); inp.focus();
        const save = async ()=>{
          const val = inp.value; td.textContent = val;
          await fetch(`/api/devices/${encodeURIComponent(no)}`, {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({[field]: val})});
        };
        inp.addEventListener('blur', save);
        inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); }});
      });
    });
  // 单设备命令交由委托事件处理（见下方），这里不再逐个绑定
  }

  function renderMap(items){
    if(!leafletMap){
      leafletMap = L.map('map').setView([31.23, 121.47], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(leafletMap);
    }
    markers.forEach(m=>leafletMap.removeLayer(m)); markers=[];
    items.forEach(d=>{
      if(d.location_lat && d.location_lng){
        const m = L.marker([d.location_lat, d.location_lng]).addTo(leafletMap);
        m.bindPopup(`<b>${d.device_no}</b><br>${d.status}<br>${d.last_seen?d.last_seen.replace('T',' ').slice(0,16):''}`);
        m.on('click', ()=>{
          // 高亮表格行
          const link = document.querySelector(`#tbl a[href='/devices/${CSS.escape(d.device_no)}']`);
          if(link){ link.closest('tr').classList.add('table-warning'); setTimeout(()=>link.closest('tr').classList.remove('table-warning'), 1500); }
        });
        markers.push(m);
      }
    });
  }

  // UI 事件
  ['qSearch','qStatus','qMerchant','qPageSize'].forEach(id=> document.getElementById(id).addEventListener('change', loadData));
  document.getElementById('exportCsv').onclick = ()=>{ window.location = '/api/devices/export?' + buildQuery(); };
  document.getElementById('batchCmd').onclick = ()=>{ new bootstrap.Modal(document.getElementById('cmdModal')).show(); };
  document.getElementById('sendCmd').onclick = async ()=>{
    const nos = Array.from(selected);
    if(nos.length===0) return alert('请选择设备');
    const type = document.getElementById('cmdType').value;
    const resp = await fetch('/api/devices/commands', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({device_nos: nos, command_type: type, payload:{}})});
    alert(await resp.text());
    bootstrap.Modal.getInstance(document.getElementById('cmdModal')).hide();
  };

  // 委托事件：行内“命令”按钮 -> 打开单设备命令弹窗
  document.querySelector('#tbl').addEventListener('click', (e)=>{
    const btn = e.target.closest('.single-cmd');
    if(btn){
      const dno = btn.dataset.no;
      const el = document.getElementById('singleCmdDevice');
      el.textContent = dno;
      el.dataset.no = dno;
      new bootstrap.Modal(document.getElementById('singleCmdModal')).show();
    }
  });

  // 单设备命令发送
  document.getElementById('sendSingleCmd').addEventListener('click', async ()=>{
    const dno = document.getElementById('singleCmdDevice').dataset.no;
    const type = document.getElementById('singleCmdType').value;
    const resp = await fetch('/api/devices/commands', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({device_nos: [dno], command_type: type, payload:{}})});
    alert(await resp.text());
    bootstrap.Modal.getInstance(document.getElementById('singleCmdModal')).hide();
  });

  // 列选择
  document.getElementById('chooseCols').onclick = ()=>{
    const modal = new bootstrap.Modal(document.getElementById('colModal'));
    const cols = Array.from(document.querySelectorAll('#tbl thead th')).map((th,i)=>({i, name: th.textContent.trim()}));
    const cont = document.getElementById('colContainer'); cont.innerHTML='';
    cols.forEach(c=>{ if(c.i===0 || c.name==='操作') return; const div=document.createElement('div'); div.className='form-check'; div.innerHTML=`<input class='form-check-input' type='checkbox' id='col_${c.i}' checked data-i='${c.i}'><label class='form-check-label' for='col_${c.i}'>${c.name}</label>`; cont.appendChild(div);});
    document.getElementById('applyCols').onclick = ()=>{
      cont.querySelectorAll('input[type=checkbox]').forEach(chk=>{
        const i = parseInt(chk.dataset.i); const visible = chk.checked;
        dt.column(i).visible(visible);
      });
      modal.hide();
    };
    modal.show();
  };

  // 初次加载
  loadData();
</script>
{% endblock %}
