{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3"><i class="bi bi-archive"></i> 物料管理</h3>
<div class="card mb-3">
  <div class="card-body">
    <form id="f" class="row g-2 align-items-end">
      <div class="col-md-3"><label class="form-label">设备编号</label><input id="qDevice" class="form-control" placeholder="如 DEMO-1001"></div>
      <div class="col-md-3"><label class="form-label">物料类型</label><input id="qType" class="form-control" placeholder="豆/奶粉/糖浆/纸杯/搅拌棒"></div>
      <div class="col-md-3"><label class="form-label">物料名称</label><input id="qName" class="form-control" placeholder="如 咖啡豆"></div>
      <div class="col-md-2"><label class="form-label">每页</label><select id="qPageSize" class="form-select"><option>20</option><option>50</option><option>100</option></select></div>
      <div class="col-md-1"><button class="btn btn-primary w-100" type="submit">查询</button></div>
    </form>
    <div class="mt-2 d-flex gap-2">
      <button class="btn btn-outline-secondary" id="btnExport"><i class="bi bi-download"></i> 导出筛选结果</button>
      <a class="btn btn-outline-secondary" href="/api/materials/export">导出全部设备</a>
    </div>
  </div>
  </div>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle" id="tbl">
    <thead><tr>
      <th>设备编号</th><th>设备名称</th><th>料盒ID</th><th>物料名称</th><th>物料类型</th><th>当前余量</th><th>最大容量</th><th>剩余%</th><th>单位</th><th>上次同步</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let dt;
  const $ = (s)=>document.querySelector(s);
  function buildQuery(page=1){
    const p = new URLSearchParams();
    if($('#qDevice').value) p.set('device_id', $('#qDevice').value);
    if($('#qType').value) p.set('type', $('#qType').value);
    if($('#qName').value) p.set('name', $('#qName').value);
    p.set('page', page); p.set('per_page', $('#qPageSize').value||'20');
    return p.toString();
  }
  async function load(page=1){
    const res = await fetch('/api/materials?' + buildQuery(page));
    const data = await res.json();
    const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML = '';
    (data.items||[]).forEach(it=>{
      const tr = document.createElement('tr');
      const percent = it.percent||0; const red = (it.capacity>0 && percent < 20);
      tr.innerHTML = `
        <td>${it.device_no||''}</td>
        <td>${it.device_name||''}</td>
        <td>${it.bin_id}</td>
        <td>${it.material_name||''}</td>
        <td>${it.material_type||''}</td>
        <td ${red?"class='text-danger fw-semibold'":''}>${(it.remain??0).toFixed(2)}</td>
        <td>${(it.capacity??0).toFixed(2)}</td>
        <td ${red?"class='text-danger fw-semibold'":''}>${(percent).toFixed(1)}</td>
        <td>${it.unit||''}</td>
        <td>${it.updated_at?it.updated_at.replace('T',' ').slice(0,19):''}</td>`;
      tbody.appendChild(tr);
    });
    if(dt) dt.destroy();
    dt = new DataTable('#tbl', {
      pageLength: parseInt($('#qPageSize').value||'20'),
      pagingType: 'simple_numbers',
      dom: 't<"d-flex justify-content-between align-items-center mt-2"ip>',
      language: {
        paginate: { previous: '上一页', next: '下一页' },
        info: '第 _PAGE_ / 共 _PAGES_ 页（共 _TOTAL_ 条）',
        infoEmpty: '无记录',
        zeroRecords: '无匹配记录'
      }
    });
  }
  document.getElementById('f').addEventListener('submit', (e)=>{ e.preventDefault(); load(1); });
  document.getElementById('qPageSize').addEventListener('change', ()=> load(1));
  document.getElementById('btnExport').onclick = ()=>{ window.location = '/api/materials/export?' + buildQuery(1); };
  load(1);
</script>
{% endblock %}