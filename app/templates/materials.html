{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3"><i class="bi bi-box-seam"></i> 物料与料盒管理（整合）</h3>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-boxes"></i> 物料字典</span>
        <div class="d-flex gap-2">
          <button id="btnNew" class="btn btn-primary btn-sm">新增</button>
          <label class="btn btn-outline-secondary btn-sm mb-0">导入CSV<input type="file" id="csvFile" accept=".csv" hidden></label>
          <a class="btn btn-outline-secondary btn-sm" href="/api/material_catalog/export">导出CSV</a>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-2 mb-2">
          <div class="col"><input id="q" class="form-control form-control-sm" placeholder="关键字/编码"></div>
          <div class="col-auto"><button id="btnSearch" class="btn btn-sm btn-secondary">搜索</button></div>
        </div>
        <div class="table-responsive" style="max-height:420px; overflow:auto">
          <table class="table table-sm align-middle" id="tblMat">
            <thead><tr><th>Code</th><th>名称</th><th>分类</th><th>单位</th><th>默认容量</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-grid-3x3-gap"></i> 设备料盒</span>
        <div class="d-flex align-items-center gap-2">
          <select id="devSel" class="form-select form-select-sm" style="min-width:180px">
            {% for d in devices %}<option value="{{ d.id }}">{{ d.device_no }}</option>{% endfor %}
          </select>
          <button id="btnInit" class="btn btn-sm btn-outline-primary">初始化</button>
          <a class="btn btn-sm btn-outline-secondary" href="/devices/bins/bulk">批量绑定</a>
          <button id="btnExport" class="btn btn-sm btn-outline-secondary">导出</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive" style="max-height:420px; overflow:auto">
          <table class="table table-sm align-middle" id="tblBin">
            <thead><tr><th>Bin</th><th>物料</th><th>单位</th><th>容量</th><th>余量</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 编辑物料弹窗 -->
<div class="modal" tabindex="-1" id="matModal"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">物料</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <div class="mb-2"><label class="form-label">编码</label><input id="f_code" class="form-control"></div>
    <div class="mb-2"><label class="form-label">名称</label><input id="f_name" class="form-control" required></div>
    <div class="mb-2"><label class="form-label">分类</label><input id="f_cat" class="form-control" placeholder="bean/milk/syrup/cup/accessory"></div>
    <div class="mb-2"><label class="form-label">单位</label><input id="f_unit" class="form-control" placeholder="g/ml/pcs"></div>
    <div class="mb-2"><label class="form-label">默认容量</label><input id="f_cap" type="number" step="0.1" class="form-control"></div>
    <div class="mb-2"><label class="form-label">描述</label><textarea id="f_desc" class="form-control"></textarea></div>
    <div class="form-check"><input id="f_active" class="form-check-input" type="checkbox" checked><label class="form-check-label">启用</label></div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button id="btnSave" class="btn btn-primary">保存</button></div>
</div></div></div>

<!-- 绑定弹窗 -->
<div class="modal" tabindex="-1" id="bindModal"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">绑定物料</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <div class="mb-2"><label class="form-label">物料编码或ID</label><input id="mCode" class="form-control" placeholder="material_code 或 material_id"></div>
    <div class="form-check"><input id="mSync" class="form-check-input" type="checkbox"><label class="form-check-label">立即下发到设备</label></div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button id="btnBindSubmit" class="btn btn-primary">绑定</button></div>
</div></div></div>

<script>
const qs = s=>document.querySelector(s);
// ------- 物料字典 -------
const matModal = new bootstrap.Modal('#matModal'); let editingId=null;
async function loadMat(){
  const p = new URLSearchParams(); if(qs('#q').value) p.set('q',qs('#q').value);
  const res = await fetch('/api/material_catalog?'+p.toString()); const j = await res.json();
  const tb = qs('#tblMat tbody'); tb.innerHTML='';
  (j.items||[]).forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${it.code||''}</td><td>${it.name}</td><td>${it.category||''}</td><td>${it.unit||''}</td><td>${it.default_capacity??''}</td>
    <td><button class='btn btn-sm btn-outline-primary me-1' data-act='edit'>编辑</button><button class='btn btn-sm btn-outline-danger' data-act='del'>删除</button></td>`;
    tr.querySelector('[data-act=edit]').onclick=()=>{ editingId=it.id; qs('#f_code').value=it.code||''; qs('#f_name').value=it.name; qs('#f_cat').value=it.category||''; qs('#f_unit').value=it.unit||''; qs('#f_cap').value=it.default_capacity??''; qs('#f_desc').value=it.description||''; qs('#f_active').checked=!!it.is_active; matModal.show(); };
    tr.querySelector('[data-act=del]').onclick=async()=>{ if(!confirm('确认删除?'))return; await fetch('/api/material_catalog/'+it.id,{method:'DELETE'}); loadMat(); };
    tb.appendChild(tr);
  });
}
qs('#btnSearch').onclick=loadMat;
qs('#btnNew').onclick=()=>{ editingId=null; qs('#f_code').value=''; qs('#f_name').value=''; qs('#f_cat').value=''; qs('#f_unit').value='g'; qs('#f_cap').value=''; qs('#f_desc').value=''; qs('#f_active').checked=true; matModal.show(); };
qs('#btnSave').onclick=async()=>{
  const body={code:qs('#f_code').value||null, name:qs('#f_name').value, category:qs('#f_cat').value||null, unit:qs('#f_unit').value||'g', default_capacity:qs('#f_cap').value?Number(qs('#f_cap').value):null, description:qs('#f_desc').value||null, is_active:qs('#f_active').checked};
  if(!body.name){ alert('名称必填'); return; }
  if(editingId){ await fetch('/api/material_catalog/'+editingId,{method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); }
  else { await fetch('/api/material_catalog',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); }
  matModal.hide(); loadMat();
};
qs('#csvFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const fd=new FormData(); fd.append('file', f); const res=await fetch('/api/material_catalog/import',{method:'POST', body:fd}); const j=await res.json(); alert('导入完成: '+JSON.stringify(j.data||j)); loadMat(); });

// ------- 设备料盒 -------
const bindModal = new bootstrap.Modal('#bindModal'); let curIdx=null;
async function loadBins(){ const deviceId = qs('#devSel').value; const r=await fetch(`/api/devices/${deviceId}/bins`); const rows=await r.json(); const tb=qs('#tblBin tbody'); tb.innerHTML='';
  rows.sort((a,b)=>a.bin_index-b.bin_index).forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${x.bin_index}</td><td>${x.material? (x.material.name + (x.material.code? ' ['+x.material.code+']':'')) : '-'}</td><td>${x.unit||''}</td><td>${x.capacity??''}</td><td>${x.remaining??''}</td>`+
    `<td><button class='btn btn-sm btn-outline-primary me-1' data-act='bind'>绑定/更换</button>`+
    `<button class='btn btn-sm btn-outline-secondary me-1' data-act='cap'>容量</button>`+
    `<button class='btn btn-sm btn-outline-warning' data-act='sync'>下发</button></td>`;
    tr.querySelector('[data-act=bind]').onclick=()=>{ curIdx=x.bin_index; qs('#mCode').value=''; qs('#mSync').checked=false; bindModal.show(); };
    tr.querySelector('[data-act=cap]').onclick=async()=>{ const v=prompt('容量'); if(!v) return; const deviceId = qs('#devSel').value; await fetch(`/api/devices/${deviceId}/bins/${x.bin_index}/set_capacity`,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({capacity:Number(v)})}); loadBins(); };
    tr.querySelector('[data-act=sync]').onclick=async()=>{ const deviceId = qs('#devSel').value; await fetch(`/api/devices/${deviceId}/bins/${x.bin_index}/downlink`,{method:'POST'}); alert('已触发下发'); };
    tb.appendChild(tr);
  });
}
qs('#btnInit').onclick=async()=>{ const deviceId = qs('#devSel').value; const cnt=prompt('料盒数量'); if(!cnt) return; const cap=prompt('默认容量(可空)'); const bins=[]; for(let i=1;i<=Number(cnt);i++){ bins.push({bin_index:i, capacity: cap? Number(cap): null}); } await fetch(`/api/devices/${deviceId}/bins`,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({bins})}); loadBins(); };
qs('#btnExport').onclick=()=>{ const deviceId = qs('#devSel').value; window.location = `/api/devices/bins/export?device_id=${deviceId}`; };
qs('#devSel').addEventListener('change', loadBins);

// 初始加载
loadMat(); loadBins();
</script>
{% endblock %}
