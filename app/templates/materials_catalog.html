{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-boxes"></i> 物料字典管理</h4>
  <div class="d-flex gap-2">
    <button id="btnNew" class="btn btn-primary btn-sm">新增物料</button>
    <label class="btn btn-outline-secondary btn-sm mb-0">
      导入 CSV <input type="file" id="csvFile" accept=".csv" hidden>
    </label>
    <a class="btn btn-outline-secondary btn-sm" href="/api/material_catalog/export">导出 CSV</a>
  </div>
</div>
<div class="row g-3 mb-2">
  <div class="col-auto"><input id="q" class="form-control form-control-sm" placeholder="关键字/编码"></div>
  <div class="col-auto">
    <select id="cat" class="form-select form-select-sm">
      <option value="">全部分类</option>
      <option value="bean">咖啡豆</option>
      <option value="milk">奶粉</option>
      <option value="syrup">糖浆</option>
      <option value="cup">杯子</option>
      <option value="accessory">辅料</option>
    </select>
  </div>
  <div class="col-auto"><button id="btnSearch" class="btn btn-sm btn-secondary">搜索</button></div>
</div>
<table class="table table-sm table-hover align-middle" id="tbl">
  <thead><tr><th>Code</th><th>名称</th><th>分类</th><th>单位</th><th>默认容量</th><th>状态</th><th>操作</th></tr></thead>
  <tbody></tbody>
</table>

<!-- 编辑弹窗 -->
<div class="modal" tabindex="-1" id="editModal">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">物料</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-2"><label class="form-label">编码</label><input id="f_code" class="form-control"></div>
      <div class="mb-2"><label class="form-label">名称</label><input id="f_name" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">分类</label><input id="f_cat" class="form-control" placeholder="bean/milk/syrup/cup/accessory"></div>
      <div class="mb-2"><label class="form-label">单位</label><input id="f_unit" class="form-control" placeholder="g/ml/个"></div>
      <div class="mb-2"><label class="form-label">默认容量</label><input id="f_cap" type="number" step="0.1" class="form-control"></div>
      <div class="mb-2"><label class="form-label">描述</label><textarea id="f_desc" class="form-control"></textarea></div>
      <div class="form-check"><input id="f_active" class="form-check-input" type="checkbox" checked><label class="form-check-label">启用</label></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button id="btnSave" class="btn btn-primary">保存</button></div>
  </div></div>
</div>

<script>
const qs = s=>document.querySelector(s);
const modal = new bootstrap.Modal('#editModal');
let editingId = null;
async function load(){
  const p = new URLSearchParams(); if(qs('#q').value) p.set('q',qs('#q').value); if(qs('#cat').value) p.set('category',qs('#cat').value);
  const res = await fetch('/api/material_catalog?'+p.toString()); const j = await res.json();
  const tb = qs('#tbl tbody'); tb.innerHTML='';
  j.items.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${it.code||''}</td><td>${it.name}</td><td>${it.category||''}</td><td>${it.unit||''}</td><td>${it.default_capacity??''}</td><td>${it.is_active?'启用':'停用'}</td>
      <td><button class='btn btn-sm btn-outline-primary me-1' data-act='edit'>编辑</button><button class='btn btn-sm btn-outline-danger' data-act='del'>删除</button></td>`;
    tr.querySelector('[data-act=edit]').onclick=()=>{ editingId=it.id; qs('#f_code').value=it.code||''; qs('#f_name').value=it.name; qs('#f_cat').value=it.category||''; qs('#f_unit').value=it.unit||''; qs('#f_cap').value=it.default_capacity??''; qs('#f_desc').value=it.description||''; qs('#f_active').checked=!!it.is_active; modal.show(); };
    tr.querySelector('[data-act=del]').onclick=async()=>{ if(!confirm('确认删除?'))return; await fetch('/api/material_catalog/'+it.id,{method:'DELETE'}); load(); };
    tb.appendChild(tr);
  });
}
qs('#btnSearch').onclick=load;
qs('#btnNew').onclick=()=>{ editingId=null; qs('#f_code').value=''; qs('#f_name').value=''; qs('#f_cat').value=''; qs('#f_unit').value='g'; qs('#f_cap').value=''; qs('#f_desc').value=''; qs('#f_active').checked=true; modal.show(); };
qs('#btnSave').onclick=async()=>{
  const body={code:qs('#f_code').value||null, name:qs('#f_name').value, category:qs('#f_cat').value||null, unit:qs('#f_unit').value||'g', default_capacity:qs('#f_cap').value?Number(qs('#f_cap').value):null, description:qs('#f_desc').value||null, is_active:qs('#f_active').checked};
  if(!body.name){ alert('名称必填'); return; }
  if(editingId){ await fetch('/api/material_catalog/'+editingId,{method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); }
  else { await fetch('/api/material_catalog',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); }
  modal.hide(); load();
};
qs('#csvFile').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const fd=new FormData(); fd.append('file', f); const res=await fetch('/api/material_catalog/import',{method:'POST', body:fd}); const j=await res.json(); alert('导入完成: '+JSON.stringify(j.data||j)); load(); });
load();
</script>
{% endblock %}
