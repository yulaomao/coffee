{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3"><i class="bi bi-exclamation-triangle"></i> 异常订单</h3>
<div class="row g-2 mb-3">
  <div class="col-auto"><input id="qFrom" type="date" class="form-control form-control-sm"></div>
  <div class="col-auto"><input id="qTo" type="date" class="form-control form-control-sm"></div>
  <div class="col-auto"><input id="qMerchant" class="form-control form-control-sm" placeholder="商户ID"></div>
  <div class="col-auto"><button id="btnSearch" class="btn btn-sm btn-primary">查询</button></div>
  <div class="col-auto"><button id="btnExport" class="btn btn-sm btn-outline-secondary">导出 CSV</button></div>
</div>
<table id="tbl" class="table table-striped table-hover">
  <thead><tr><th>订单号</th><th>时间</th><th>设备</th><th>支付方式</th><th>支付状态</th><th>退款信息</th></tr></thead>
  <tbody></tbody>
</table>
<script>
  let dt;
  function buildQuery(){
    const p = new URLSearchParams();
    if(qFrom.value) p.set('from', qFrom.value);
    if(qTo.value) p.set('to', qTo.value);
    if(qMerchant.value) p.set('merchant_id', qMerchant.value);
    return p.toString();
  }
  async function load(){
    const res = await fetch('/api/orders/exceptions?' + buildQuery());
    const data = await res.json();
    const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML='';
    (data||[]).forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.order_no}</td><td>${o.created_at.replace('T',' ').slice(0,19)}</td><td>${o.device_id||''}</td><td>${o.pay_method||''}</td><td>${o.pay_status||''}</td><td><pre class="mb-0 small">${o.refund_info?JSON.stringify(o.refund_info):''}</pre></td>`;
      tbody.appendChild(tr);
    });
    if(dt) dt.destroy(); dt = new DataTable('#tbl', {pageLength: 50});
  }
  document.getElementById('btnSearch').onclick = load;
  document.getElementById('btnExport').onclick = ()=>{ window.location = '/api/orders/export?' + buildQuery() + '&is_exception=1'; };
  load();
</script>
{% endblock %}
