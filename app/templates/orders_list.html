{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3"><i class="bi bi-receipt"></i> 订单列表</h3>
<div class="row g-2 mb-3">
  <div class="col-auto"><input id="qFrom" type="date" class="form-control form-control-sm"></div>
  <div class="col-auto"><input id="qTo" type="date" class="form-control form-control-sm"></div>
  <div class="col-auto"><input id="qMerchant" class="form-control form-control-sm" placeholder="商户ID"></div>
  <div class="col-auto"><input id="qDevice" class="form-control form-control-sm" placeholder="设备ID"></div>
  <div class="col-auto"><input id="qProduct" class="form-control form-control-sm" placeholder="产品ID"></div>
  <div class="col-auto">
    <select id="qPayMethod" class="form-select form-select-sm">
      <option value="">支付方式</option>
      <option value="cash">现金</option>
      <option value="wechat">微信</option>
      <option value="alipay">支付宝</option>
    </select>
  </div>
  <div class="col-auto">
    <select id="qStatus" class="form-select form-select-sm">
      <option value="">状态</option>
      <option value="paid">已支付</option>
      <option value="refund_pending">退款中</option>
      <option value="refunded">已退款</option>
      <option value="failed">失败</option>
    </select>
  </div>
  <div class="col-auto"><button id="btnSearch" class="btn btn-sm btn-primary">查询</button></div>
  <div class="col-auto"><button id="btnExport" class="btn btn-sm btn-outline-secondary">导出 CSV</button></div>
</div>
<table id="tbl" class="table table-striped table-hover">
  <thead><tr><th>订单号</th><th>时间</th><th>设备</th><th>产品</th><th>数量</th><th>金额</th><th>支付方式</th><th>支付状态</th><th>操作</th></tr></thead>
  <tbody></tbody>
</table>

<!-- 退款弹窗 -->
<div class="modal" tabindex="-1" id="refundModal">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">人工退款</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div>订单号：<code id="refundOrder"></code></div>
      <label class="form-label mt-2">原因</label>
      <input id="refundReason" class="form-control" placeholder="填写退款原因">
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" id="doRefund">提交退款</button></div>
  </div></div>
</div>

<script>
  let dt;
  function buildQuery(){
    const p = new URLSearchParams();
    if(qFrom.value) p.set('from', qFrom.value);
    if(qTo.value) p.set('to', qTo.value);
    if(qMerchant.value) p.set('merchant_id', qMerchant.value);
    if(qDevice.value) p.set('device_id', qDevice.value);
    if(qProduct.value) p.set('product_id', qProduct.value);
    if(qPayMethod.value) p.set('pay_method', qPayMethod.value);
    if(qStatus.value) p.set('pay_status', qStatus.value);
    p.set('page','1'); p.set('per_page','50');
    return p.toString();
  }
  async function load(){
    const res = await fetch('/api/orders?' + buildQuery());
    const data = await res.json();
    const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML='';
    (data.items||[]).forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="#" class="view" data-no="${o.order_no}">${o.order_no}</a></td><td>${o.created_at.replace('T',' ').slice(0,19)}</td><td>${o.device_id||''}</td><td>${o.product_name||o.product_id||''}</td><td>${o.qty}</td><td>￥${(o.total_amount||0).toFixed?o.total_amount.toFixed(2):Number(o.total_amount).toFixed(2)}</td><td>${o.pay_method}</td><td>${o.pay_status}</td><td><button class="btn btn-sm btn-outline-danger refund" data-no="${o.order_no}">退款</button></td>`;
      tbody.appendChild(tr);
    });
    if(dt) dt.destroy(); dt = new DataTable('#tbl', {pageLength: 50});
  }
  document.getElementById('btnSearch').onclick = load;
  document.getElementById('btnExport').onclick = ()=>{ window.location = '/api/orders/export?' + buildQuery(); };
  document.querySelector('#tbl').addEventListener('click', async (e)=>{
    const v = e.target.closest('.view'); if(v){ e.preventDefault(); const res = await fetch('/api/orders/' + v.dataset.no); const j=await res.json(); alert(JSON.stringify(j,null,2)); return; }
    const r = e.target.closest('.refund'); if(r){ document.getElementById('refundOrder').textContent=r.dataset.no; new bootstrap.Modal(document.getElementById('refundModal')).show(); }
  });
  document.getElementById('doRefund').onclick = async ()=>{
    const no = document.getElementById('refundOrder').textContent; const reason = document.getElementById('refundReason').value||'manual';
    const res = await fetch(`/api/orders/${encodeURIComponent(no)}/manual_refund`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason})});
    alert(await res.text()); bootstrap.Modal.getInstance(document.getElementById('refundModal')).hide();
  };
  load();
</script>
{% endblock %}
