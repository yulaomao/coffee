{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h3 class="m-0">配方包管理</h3>
  <div>
    <label class="btn btn-outline-secondary mb-0">
      上传包<input type="file" id="file" hidden>
    </label>
  </div>
  
</div>

<table id="tbl" class="table table-striped table-hover">
  <thead><tr><th>ID</th><th>文件名</th><th>MD5</th><th>大小</th><th>时间</th><th>操作</th></tr></thead>
  <tbody></tbody>
  
</table>

<script>
  let dt;
  async function load(){
    const j = await (await fetch('/api/recipes/packages')).json();
    const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
    (j.items||[]).forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.id}</td><td>${p.package_name}</td><td class="small">${p.md5}</td><td>${(p.size_bytes/1024).toFixed(1)} KB</td><td>${p.created_at.replace('T',' ').slice(0,19)}</td>
        <td>
          <a class="btn btn-sm btn-outline-secondary" href="/api/recipes/packages/${p.id}/download">下载</a>
          <button class="btn btn-sm btn-primary" data-id="${p.id}" onclick="dispatchPkg(${p.id})">下发</button>
        </td>`;
      tb.appendChild(tr);
    });
    if(dt) dt.destroy();
    dt = new DataTable('#tbl', { pagingType:'simple_numbers', dom:'t<"d-flex justify-content-between align-items-center mt-2"ip>', language:{paginate:{previous:'上一页', next:'下一页'}, info:'第 _PAGE_ / 共 _PAGES_ 页（共 _TOTAL_ 条）', infoEmpty:'无记录', zeroRecords:'无匹配记录'}});
  }

  async function dispatchPkg(id){
    const ids = prompt('输入设备ID列表，用逗号分隔');
    if(!ids) return;
    const device_ids = ids.split(',').map(s=>parseInt(s.trim())).filter(Boolean);
    const r = await fetch('/api/recipes/packages/'+id+'/dispatch', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({device_ids})});
    const j = await r.json(); if(j.ok){ location.href = '/recipes/dispatches/'+j.batch_id; }
  }

  document.getElementById('file').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const fd = new FormData(); fd.append('file', f);
    const r = await fetch('/api/recipes/packages/upload', {method:'POST', body: fd});
    const j = await r.json(); if(j.ok){ alert('上传成功'); load(); }
  });

  load();
</script>
{% endblock %}
