{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h3 class="m-0"><i class="bi bi-diagram-3"></i> 配方管理</h3>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" id="btnNew">新建配方</button>
    <a class="btn btn-outline-secondary" href="/api/recipes?format=csv">导出 CSV</a>
  </div>
</div>

<div class="row g-2 mb-2">
  <div class="col-auto"><input id="q" class="form-control form-control-sm" placeholder="关键字"></div>
  <div class="col-auto"><select id="st" class="form-select form-select-sm"><option value="">状态(全部)</option><option value="draft">草稿</option><option value="published">已发布</option><option value="deprecated">废弃</option></select></div>
  <div class="col-auto"><input id="model" class="form-control form-control-sm" placeholder="适用机型"></div>
  <div class="col-auto"><input id="author" class="form-control form-control-sm" placeholder="作者ID"></div>
  <div class="col-auto"><button class="btn btn-sm btn-primary" id="btnSearch">查询</button></div>
</div>

<table id="tbl" class="table table-striped table-hover">
  <thead><tr><th>ID</th><th>名称</th><th>版本</th><th>状态</th><th>作者</th><th>创建时间</th><th>操作</th></tr></thead>
  <tbody></tbody>
</table>

<script>
  let dt;
  function buildQuery(){
    const p = new URLSearchParams();
    if(q.value) p.set('q', q.value);
    if(st.value) p.set('status', st.value);
    if(model.value) p.set('model', model.value);
    if(author.value) p.set('author', author.value);
    return p.toString();
  }
  async function load(){
    const j = await (await fetch('/api/recipes?' + buildQuery())).json();
    const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
    (j.items||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.id}</td><td><a href="/recipes/${r.id}">${r.name}</a></td><td>${r.version||''}</td><td>${r.status}</td><td>${r.author_id||''}</td><td>${r.created_at.replace('T',' ').slice(0,19)}</td>
        <td class="d-flex gap-2"><a class="btn btn-sm btn-outline-secondary" href="/recipes/${r.id}">查看</a><a class="btn btn-sm btn-primary" href="/recipes/${r.id}/edit">编辑</a></td>`;
      tb.appendChild(tr);
    });
    if(dt) dt.destroy();
    dt = new DataTable('#tbl', { pagingType:'simple_numbers', dom:'t<"d-flex justify-content-between align-items-center mt-2"ip>', language:{paginate:{previous:'上一页', next:'下一页'}, info:'第 _PAGE_ / 共 _PAGES_ 页（共 _TOTAL_ 条）', infoEmpty:'无记录', zeroRecords:'无匹配记录'}});
  }
  document.getElementById('btnSearch').onclick = load;
  document.getElementById('btnNew').onclick = ()=>{ location.href = '/recipes/new'; };
  load();
</script>
{% endblock %}
